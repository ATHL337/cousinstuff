{{/* layouts/partials/rads-score.html
   Returns a dict: {score, tier, label, votes, slug}
   NOTE: This partial must RETURN a dict (not HTML) so callers can use $r.tier, $r.score, etc.
*/}}

{{- $slug := "" -}}
{{- with .Params.slug -}}
  {{- $slug = . -}}
{{- else -}}
  {{- with .File.ContentBaseName -}}{{- $slug = . -}}{{- end -}}
{{- end -}}

{{- $votesAll := site.Data.rads_votes -}}
{{- $v := dict -}}
{{- with $votesAll -}}
  {{- with (index . $slug) -}}
    {{- $v = . -}}
  {{- end -}}
{{- end -}}

{{/* Expecting something like:
   rads_votes.yaml:
     radstorm-citrus-garlic-shrimp-tacos:
       you: 15
       spouse: 5
       k1: 15
       k2: 15
       k3: 15
       k4: 5
*/}}

{{- $you := int (default 0 (index $v "you")) -}}
{{- $spouse := int (default 0 (index $v "spouse")) -}}
{{- $k1 := int (default 0 (index $v "k1")) -}}
{{- $k2 := int (default 0 (index $v "k2")) -}}
{{- $k3 := int (default 0 (index $v "k3")) -}}
{{- $k4 := int (default 0 (index $v "k4")) -}}

{{/* Family-first weighted model (won’t “ruin” scoring):
   - You: 1.0
   - Spouse: 1.2  (keeps household stability)
   - Kids: 1.5 each (family-first)
*/}}
{{- $score := add (mul $you 1.0) (mul $spouse 1.2) (mul (add $k1 $k2 $k3 $k4) 1.5) -}}
{{- $score = math.Round $score -}}

{{/* Tiering thresholds (tune later):
   - Core Lock: >= 120
   - Core Candidate: >= 90
   - Specialty: >= 60
   - Wildcard: >= 30
   - Unscored: else
*/}}
{{- $tier := "unscored" -}}
{{- if ge $score 120 -}}
  {{- $tier = "core-lock" -}}
{{- else if ge $score 90 -}}
  {{- $tier = "core-candidate" -}}
{{- else if ge $score 60 -}}
  {{- $tier = "specialty" -}}
{{- else if ge $score 30 -}}
  {{- $tier = "wildcard" -}}
{{- end -}}

{{- $label := "Unscored" -}}
{{- if eq $tier "core-lock" -}}{{- $label = "Core Lock" -}}{{- end -}}
{{- if eq $tier "core-candidate" -}}{{- $label = "Core Candidate" -}}{{- end -}}
{{- if eq $tier "specialty" -}}{{- $label = "Specialty" -}}{{- end -}}
{{- if eq $tier "wildcard" -}}{{- $label = "Wildcard" -}}{{- end -}}

{{- $votes := dict "you" $you "spouse" $spouse "k1" $k1 "k2" $k2 "k3" $k3 "k4" $k4 -}}

{{- return (dict
  "slug" $slug
  "score" (int $score)
  "tier" $tier
  "label" $label
  "votes" $votes
) -}}
