{{- /* RADS score calculator
      Returns a dict:
      - scoreRaw (float)
      - score (string, whole number)
      - tier (string: core-lock|core-candidate|specialty|wildcard|unscored)
      - label (string)
*/ -}}

{{- $site := site -}}
{{- with .site -}}{{- $site = . -}}{{- end -}}

{{- $slug := "" -}}
{{- with .slug -}}
  {{- $slug = . -}}
{{- else -}}
  {{- /* If called with a Page */ -}}
  {{- $slug = or .Params.slug .File.ContentBaseName -}}
{{- end -}}

{{- $votes := $site.Data.rads_votes | default dict -}}
{{- $row := or (index $votes $slug) (dict) -}}

{{- /* Votes (coerce to float so weights behave consistently) */ -}}
{{- $you    := float (or (index $row "you") 0) -}}
{{- $spouse := float (or (index $row "spouse") 0) -}}
{{- $k1     := float (or (index $row "k1") 0) -}}
{{- $k2     := float (or (index $row "k2") 0) -}}
{{- $k3     := float (or (index $row "k3") 0) -}}
{{- $k4     := float (or (index $row "k4") 0) -}}

{{- /* Family-first weights (tweak here without breaking math) */ -}}
{{- $wYou := 1.2 -}}
{{- $wSp  := 1.0 -}}
{{- $wKid := 0.9 -}}

{{- $scoreRaw := 0.0 -}}
{{- $scoreRaw = add $scoreRaw (mul $you $wYou) -}}
{{- $scoreRaw = add $scoreRaw (mul $spouse $wSp) -}}
{{- $scoreRaw = add $scoreRaw (mul $k1 $wKid) -}}
{{- $scoreRaw = add $scoreRaw (mul $k2 $wKid) -}}
{{- $scoreRaw = add $scoreRaw (mul $k3 $wKid) -}}
{{- $scoreRaw = add $scoreRaw (mul $k4 $wKid) -}}

{{- $scoreRaw = math.Round $scoreRaw -}}
{{- $score := printf "%.0f" $scoreRaw -}}

{{- /* Tier thresholds (float comparisons) */ -}}
{{- $tier := "unscored" -}}
{{- $label := "Unscored" -}}

{{- if ge $scoreRaw 120.0 -}}
  {{- $tier = "core-lock" -}}
  {{- $label = "Core Lock" -}}
{{- else if ge $scoreRaw 95.0 -}}
  {{- $tier = "core-candidate" -}}
  {{- $label = "Core Candidate" -}}
{{- else if ge $scoreRaw 70.0 -}}
  {{- $tier = "specialty" -}}
  {{- $label = "Specialty" -}}
{{- else if ge $scoreRaw 40.0 -}}
  {{- $tier = "wildcard" -}}
  {{- $label = "Wildcard" -}}
{{- end -}}

{{- return (dict
  "slug" $slug
  "scoreRaw" $scoreRaw
  "score" $score
  "tier" $tier
  "label" $label
) -}}
