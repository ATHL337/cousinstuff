{{/* layouts/partials/rads-score.html
   Safe for:
   - partial "rads-score.html" .            (Page)
   - partial "rads-score.html" (dict ...)   (map)
   Returns dict: {slug, score, scoreDisplay, tier, label, votes}
*/}}

{{- $slug := "" -}}

{{/* If input is a dict/map, read slug from it */}}
{{- if reflect.IsMap . -}}
  {{- with (index . "slug") -}}
    {{- $slug = . -}}
  {{- end -}}
{{- end -}}

{{/* If input is a Page, prefer .Params.slug, else file basename */}}
{{- if eq $slug "" -}}
  {{- with .Params.slug -}}
    {{- $slug = . -}}
  {{- else -}}
    {{- with .File.ContentBaseName -}}
      {{- $slug = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $votesAll := site.Data.rads_votes -}}
{{- $v := dict -}}
{{- with $votesAll -}}
  {{- with (index . $slug) -}}
    {{- $v = . -}}
  {{- end -}}
{{- end -}}

{{- $you := float (default 0 (index $v "you")) -}}
{{- $spouse := float (default 0 (index $v "spouse")) -}}
{{- $k1 := float (default 0 (index $v "k1")) -}}
{{- $k2 := float (default 0 (index $v "k2")) -}}
{{- $k3 := float (default 0 (index $v "k3")) -}}
{{- $k4 := float (default 0 (index $v "k4")) -}}

{{/* Family-first weights */}}
{{- $wYou := 1.0 -}}
{{- $wSpouse := 1.2 -}}
{{- $wK1 := 1.0 -}}
{{- $wK2 := 1.0 -}}
{{- $wK3 := 1.0 -}}
{{- $wK4 := 0.5 -}}

{{- $weightedSum := add
      (mul $you $wYou)
      (mul $spouse $wSpouse)
      (mul $k1 $wK1)
      (mul $k2 $wK2)
      (mul $k3 $wK3)
      (mul $k4 $wK4)
-}}
{{- $weightTotal := add $wYou $wSpouse $wK1 $wK2 $wK3 $wK4 -}}

{{- $score := 0.0 -}}
{{- if gt $weightTotal 0.0 -}}
  {{- $score = div $weightedSum $weightTotal -}} {{/* 0–15 */}}
{{- end -}}

{{/* Tier thresholds (0–15) */}}
{{- $tier := "unscored" -}}
{{- if ge $score 13.5 -}}
  {{- $tier = "core-lock" -}}
{{- else if ge $score 11.5 -}}
  {{- $tier = "core-candidate" -}}
{{- else if ge $score 9.0 -}}
  {{- $tier = "specialty" -}}
{{- else if ge $score 6.0 -}}
  {{- $tier = "wildcard" -}}
{{- end -}}

{{- $label := "Unscored" -}}
{{- if eq $tier "core-lock" -}}{{- $label = "Core Lock" -}}{{- end -}}
{{- if eq $tier "core-candidate" -}}{{- $label = "Core Candidate" -}}{{- end -}}
{{- if eq $tier "specialty" -}}{{- $label = "Specialty" -}}{{- end -}}
{{- if eq $tier "wildcard" -}}{{- $label = "Wildcard" -}}{{- end -}}

{{- $votes := dict "you" (int $you) "spouse" (int $spouse) "k1" (int $k1) "k2" (int $k2) "k3" (int $k3) "k4" (int $k4) -}}

{{- return (dict
  "slug" $slug
  "score" $score
  "scoreDisplay" (printf "%.1f" $score)
  "tier" $tier
  "label" $label
  "votes" $votes
) -}}
