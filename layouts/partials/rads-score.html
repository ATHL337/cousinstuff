{{- /* Usage:
    {{ $r := partial "rads-score.html" (dict "slug" .Params.slug) }}
    $r.score -> float
    $r.tier  -> string
*/ -}}

{{- $slug := .slug -}}
{{- $cfg := site.Data.rads_config -}}
{{- $votesAll := site.Data.rads_votes -}}
{{- $votes := index $votesAll $slug -}}

{{- $unrated := ($cfg.defaults.unrated_score | default 0) | float -}}
{{- $tierUnrated := $cfg.defaults.tier_unrated | default "Unscored" -}}

{{- if not $votes -}}
  {{- return (dict "score" $unrated "tier" $tierUnrated "isRated" false) -}}
{{- end -}}

{{- $w := $cfg.weights -}}

{{- /* Safe getter: returns 0 if key missing */ -}}
{{- $get := func (slice) -}}
{{- end -}}

{{- $you := (index $votes "you" | default 0) | float -}}
{{- $spouse := (index $votes "spouse" | default 0) | float -}}
{{- $k1 := (index $votes "k1" | default 0) | float -}}
{{- $k2 := (index $votes "k2" | default 0) | float -}}
{{- $k3 := (index $votes "k3" | default 0) | float -}}
{{- $k4 := (index $votes "k4" | default 0) | float -}}

{{- $wYou := (index $w "you" | default 1.0) | float -}}
{{- $wSpouse := (index $w "spouse" | default 1.0) | float -}}
{{- $wK1 := (index $w "k1" | default 1.0) | float -}}
{{- $wK2 := (index $w "k2" | default 1.0) | float -}}
{{- $wK3 := (index $w "k3" | default 1.0) | float -}}
{{- $wK4 := (index $w "k4" | default 1.0) | float -}}

{{- $score := add
    (mul $you $wYou)
    (mul $spouse $wSpouse)
    (mul $k1 $wK1)
    (mul $k2 $wK2)
    (mul $k3 $wK3)
    (mul $k4 $wK4)
  -}}

{{- $t := $cfg.tiers -}}
{{- $tier := "Wildcard" -}}
{{- if ge $score (($t.core_lock | default 70) | float) -}}
  {{- $tier = "Core Lock" -}}
{{- else if ge $score (($t.core_candidate | default 45) | float) -}}
  {{- $tier = "Core Candidate" -}}
{{- else if ge $score (($t.specialty | default 25) | float) -}}
  {{- $tier = "Specialty" -}}
{{- else if ge $score (($t.wildcard | default 0) | float) -}}
  {{- $tier = "Wildcard" -}}
{{- end -}}

{{- return (dict "score" $score "tier" $tier "isRated" true) -}}
