{{/* layouts/partials/rads-score.html
     Returns a dict:
     - score (int)
     - tier (string)
     - tierClass (string)
     - voters (dict)
*/}}

{{- $in := . -}}

{{/* Resolve Site */}}
{{- $site := nil -}}
{{- with $in.Site -}}
  {{- $site = . -}}
{{- else -}}
  {{- $site = index $in "site" -}}
{{- end -}}

{{/* Resolve slug */}}
{{- $slug := "" -}}
{{- with $in.Params -}}
  {{- with .slug -}}{{- $slug = . -}}{{- end -}}
{{- end -}}
{{- if eq $slug "" -}}
  {{- with (index $in "slug") -}}{{- $slug = . -}}{{- end -}}
{{- end -}}

{{/* Load votes (data/rads_votes.yaml => .Site.Data.rads_votes) */}}
{{- $all := (index $site.Data "rads_votes") | default (dict) -}}
{{- $v := (index $all $slug) | default (dict) -}}

{{/* Pull points (ints) */}}
{{- $you    := int (default 0 (index $v "you")) -}}
{{- $spouse := int (default 0 (index $v "spouse")) -}}
{{- $k1     := int (default 0 (index $v "k1")) -}}
{{- $k2     := int (default 0 (index $v "k2")) -}}
{{- $k3     := int (default 0 (index $v "k3")) -}}
{{- $k4     := int (default 0 (index $v "k4")) -}}

{{/* Family-first weights (simple + robust):
     You x2, Spouse x2, each kid x1
     Max = 15*(2+2+1+1+1+1)=120
*/}}
{{- $raw := add (mul 2 $you) (mul 2 $spouse) $k1 $k2 $k3 $k4 -}}
{{- $score := cond (lt $raw 0) 0 $raw -}}

{{/* Tier thresholds on 0..120 scale */}}
{{- $tier := "Unscored" -}}
{{- $tierClass := "rads-tier-unscored" -}}
{{- if ge $score 105 -}}
  {{- $tier = "Core Lock" -}}
  {{- $tierClass = "rads-tier-core-lock" -}}
{{- else if ge $score 85 -}}
  {{- $tier = "Core Candidate" -}}
  {{- $tierClass = "rads-tier-core-candidate" -}}
{{- else if ge $score 55 -}}
  {{- $tier = "Specialty" -}}
  {{- $tierClass = "rads-tier-specialty" -}}
{{- else if ge $score 25 -}}
  {{- $tier = "Wildcard" -}}
  {{- $tierClass = "rads-tier-wildcard" -}}
{{- end -}}

{{- return (dict
  "score" $score
  "tier" $tier
  "tierClass" $tierClass
  "voters" (dict "you" $you "spouse" $spouse "k1" $k1 "k2" $k2 "k3" $k3 "k4" $k4)
) -}}
